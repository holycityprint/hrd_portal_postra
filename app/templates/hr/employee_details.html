{% extends 'base.html' %}
{% block content %}
<div class="container-fluid p-0 font-corp">

  <!-- 1. AREA NOTIFIKASI (PENTING: Untuk menampilkan Password Baru setelah Reset) -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-4">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm border-0" role="alert">
            <div class="d-flex align-items-center">
                <!-- Icon dinamis berdasarkan kategori -->
                <i class="bi bi-{{ 'check-circle-fill' if category == 'success' else 'exclamation-triangle-fill' }} fs-4 me-3"></i>
                <!-- Menggunakan 'safe' agar tag HTML <br> dan <b> terbaca -->
                <div>{{ message | safe }}</div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- HEADER PAGE -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h4 class="fw-bold text-dark mb-1">Detail Personil</h4>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0 small">
          <li class="breadcrumb-item"><a href="{{ url_for('hr.manage_employees') }}" class="text-decoration-none">Data Karyawan</a></li>
          <li class="breadcrumb-item active text-muted" aria-current="page">{{ employee.name }}</li>
        </ol>
      </nav>
    </div>
    <div>
      <a href="{{ url_for('hr.manage_employees') }}" class="btn btn-outline-secondary btn-sm me-2">
        <i class="bi bi-arrow-left me-1"></i>Kembali
      </a>
      
      <!-- [BARU] TOMBOL RESET PASSWORD -->
      <button type="button" class="btn btn-warning btn-sm me-2 text-dark" data-bs-toggle="modal" data-bs-target="#resetModal">
        <i class="bi bi-key-fill me-1"></i>Reset Password
      </button>

      <!-- TOMBOL CETAK PDF -->
      <a href="{{ url_for('hr.print_employee_pdf', id=employee.id) }}" target="_blank" class="btn btn-danger btn-sm me-2">
        <i class="bi bi-file-earmark-pdf me-1"></i>Cetak Biodata
      </a>

      <a href="{{ url_for('hr.edit_employee', id=employee.id) }}" class="btn btn-primary btn-sm">
        <i class="bi bi-pencil-square me-1"></i>Edit Data
      </a>
    </div>
  </div>

  <div class="row g-4">
    
    <!-- KIRI: PROFIL CARD -->
    <div class="col-lg-4 col-xl-3">
      <div class="card card-corp border-top-primary h-100">
        <div class="card-body text-center p-4">
          <!-- Foto Profil -->
          <div class="position-relative d-inline-block mb-3">
            <img src="{{ url_for('static', filename='uploads/' ~ (employee.photo or 'default_user.png')) }}"
                 class="rounded-circle shadow-sm"
                 width="120" height="120" 
                 style="object-fit:cover; border:4px solid #f8fafc;">
            <span class="position-absolute bottom-0 end-0 p-2 bg-{{ 'success' if employee.status == 'aktif' else 'secondary' }} border border-light rounded-circle"></span>
          </div>
          
          <h5 class="fw-bold text-dark mb-1">{{ employee.name }}</h5>
          <p class="text-muted mb-3 small">{{ employee.position or 'Posisi Belum Diisi' }}</p>
          
          <div class="d-grid gap-2 mb-3">
             <div class="p-2 bg-light rounded border">
                <small class="d-block text-muted text-uppercase" style="font-size:0.7rem; letter-spacing:0.5px;">Penempatan Client</small>
                <span class="fw-bold text-primary">{{ employee.client.name if employee.client else '-' }}</span>
             </div>
             <div class="p-2 bg-light rounded border">
                <small class="d-block text-muted text-uppercase" style="font-size:0.7rem; letter-spacing:0.5px;">Status Kepegawaian</small>
                <span class="fw-bold text-dark">{{ employee.job_type|capitalize }}</span>
             </div>
          </div>

          <div class="border-top pt-3 text-start">
            <small class="text-muted d-block mb-2"><i class="bi bi-envelope me-2"></i>{{ employee.email or '-' }}</small>
            <small class="text-muted d-block"><i class="bi bi-telephone me-2"></i>{{ employee.phone or '-' }}</small>
            
            <!-- [BARU] Info Username -->
            {% if employee.user %}
            <div class="mt-3 p-2 bg-info-subtle rounded small">
                <i class="bi bi-person-badge me-1"></i>Username: <strong>{{ employee.user.username }}</strong>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- KANAN: DETAIL TABS & DATA -->
    <div class="col-lg-8 col-xl-9">
      
      <!-- SECTION 1: DATA PRIBADI (Grid Layout) -->
      {% if employee.personal_detail %}
      <div class="card card-corp mb-4">
        <div class="card-header-corp bg-white border-bottom p-3">
          <h6 class="m-0 fw-bold text-dark"><i class="bi bi-person-lines-fill me-2 text-secondary"></i>Informasi Pribadi</h6>
        </div>
        <div class="card-body p-4">
          <div class="row g-3">
            <div class="col-md-6">
               <label class="small text-muted text-uppercase fw-bold">Nama Lengkap</label>
               <div class="fw-semibold text-dark border-bottom pb-1">{{ employee.personal_detail.full_name or '-' }}</div>
            </div>
            <div class="col-md-6">
               <label class="small text-muted text-uppercase fw-bold">NIK (Nomor Induk Kependudukan)</label>
               <div class="fw-semibold text-dark border-bottom pb-1">{{ employee.personal_detail.nik or '-' }}</div>
            </div>
            <div class="col-md-4">
               <label class="small text-muted text-uppercase fw-bold">Tempat, Tgl Lahir</label>
               <div class="text-dark pt-1">
                 {{ employee.personal_detail.birth_place or '-' }},
                 {% if employee.personal_detail.birth_date %}
                   {{ employee.personal_detail.birth_date.strftime('%d %B %Y') }}
                 {% else %}-{% endif %}
               </div>
            </div>
            <div class="col-md-4">
               <label class="small text-muted text-uppercase fw-bold">Jenis Kelamin</label>
               <div class="text-dark pt-1">{{ employee.personal_detail.gender or '-' }}</div>
            </div>
            <div class="col-md-4">
               <label class="small text-muted text-uppercase fw-bold">Status Pernikahan</label>
               <div class="text-dark pt-1">{{ employee.personal_detail.marital_status or '-' }}</div>
            </div>
            <div class="col-md-6">
               <label class="small text-muted text-uppercase fw-bold">Alamat KTP</label>
               <div class="text-dark pt-1 bg-light p-2 rounded small">{{ employee.personal_detail.address_ktp or '-' }}</div>
            </div>
            <div class="col-md-6">
               <label class="small text-muted text-uppercase fw-bold">Alamat Domisili</label>
               <div class="text-dark pt-1 bg-light p-2 rounded small">{{ employee.personal_detail.address_current or '-' }}</div>
            </div>
          </div>
          
          <!-- Fisik & Keluarga Toggle/Grid -->
          <div class="row g-3 mt-2">
            <div class="col-md-3">
              <label class="small text-muted">Pendidikan</label>
              <div>{{ employee.personal_detail.education or '-' }}</div>
            </div>
            <div class="col-md-3">
              <label class="small text-muted">Gol. Darah</label>
              <div>{{ employee.personal_detail.blood_type or '-' }}</div>
            </div>
            <div class="col-md-3">
              <label class="small text-muted">Tinggi/Berat</label>
              <div>{{ employee.personal_detail.height_cm or '-' }} cm / {{ employee.personal_detail.weight_kg or '-' }} kg</div>
            </div>
            <div class="col-md-3">
              <label class="small text-muted">Jml Anak</label>
              <div>{{ employee.personal_detail.num_children or 0 }}</div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <div class="row g-4">
        <!-- SECTION 2: ASURANSI -->
        <div class="col-md-6">
          <div class="card card-corp h-100">
            <div class="card-header-corp bg-white border-bottom p-3">
              <h6 class="m-0 fw-bold text-dark"><i class="bi bi-shield-check me-2 text-success"></i>Data Asuransi</h6>
            </div>
            <div class="card-body p-0">
              <table class="table table-borderless table-striped mb-0 small">
                <tbody>
                  <tr>
                    <td class="ps-4 text-muted">BPJS TK</td>
                    <td class="fw-bold text-end pe-4">{{ employee.personal_detail.bpjs_ketenagakerjaan or '-' }}</td>
                  </tr>
                  <tr>
                    <td class="ps-4 text-muted">BPJS Kes</td>
                    <td class="fw-bold text-end pe-4">{{ employee.personal_detail.bpjs_kesehatan or '-' }}</td>
                  </tr>
                  <tr>
                    <td class="ps-4 text-muted">BPJS KIS</td>
                    <td class="fw-bold text-end pe-4">{{ employee.personal_detail.bpjs_kis or '-' }}</td>
                  </tr>
                  <tr>
                    <td class="ps-4 text-muted">Jamkesda</td>
                    <td class="fw-bold text-end pe-4">{{ employee.personal_detail.jamkesda or '-' }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- SECTION 3: KONTAK DARURAT -->
        <div class="col-md-6">
          <div class="card card-corp h-100">
            <div class="card-header-corp bg-white border-bottom p-3">
              <h6 class="m-0 fw-bold text-dark"><i class="bi bi-telephone-fill me-2 text-danger"></i>Kontak Darurat</h6>
            </div>
            <div class="card-body p-3 small">
              <div class="d-flex align-items-center mb-3">
                <div class="bg-danger-subtle text-danger rounded p-2 me-3"><i class="bi bi-person-heart"></i></div>
                <div>
                  <div class="fw-bold">{{ employee.personal_detail.emergency_contact_name or '-' }}</div>
                  <div class="text-muted">{{ employee.personal_detail.emergency_relation or 'Hubungan tidak diset' }}</div>
                </div>
              </div>
              <hr class="my-2 border-light">
              <div class="mb-1"><i class="bi bi-telephone me-2 text-muted"></i>{{ employee.personal_detail.emergency_phone or '-' }}</div>
              <div><i class="bi bi-geo-alt me-2 text-muted"></i>{{ employee.personal_detail.emergency_address or '-' }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- SECTION 4: DOKUMEN & AKTIVITAS -->
      <div class="row g-4 mt-1">
        <!-- Dokumen -->
        <div class="col-12">
          <div class="card card-corp">
            <div class="card-header-corp bg-white border-bottom p-3">
              <h6 class="m-0 fw-bold text-dark"><i class="bi bi-folder-fill me-2 text-warning"></i>Arsip Dokumen</h6>
            </div>
            <div class="card-body p-3">
              {% if employee.documents %}
              <div class="row g-2">
                {% for doc in employee.documents %}
                <div class="col-sm-6 col-md-4">
                  <a href="{{ url_for('static', filename=doc.file_path) }}" target="_blank" class="text-decoration-none">
                    <div class="border rounded p-2 d-flex align-items-center bg-light hover-shadow">
                      <i class="bi bi-file-earmark-pdf text-danger fs-4 me-2"></i>
                      <div class="text-truncate small text-dark fw-semibold">{{ doc.document_type }}</div>
                    </div>
                  </a>
                </div>
                {% endfor %}
              </div>
              <!-- [BARU] Tampilan jika dokumen kosong -->
              {% else %}
              <div class="text-center py-3 text-muted">
                  <i class="bi bi-folder2-open fs-3 d-block mb-1"></i>
                  <small>Belum ada dokumen yang diunggah.</small>
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Aktivitas Harian -->
        <div class="col-12">
          <div class="card card-corp">
             <div class="card-header-corp bg-white border-bottom p-3 d-flex justify-content-between">
                <h6 class="m-0 fw-bold text-dark"><i class="bi bi-activity me-2 text-primary"></i>Log Aktivitas Terakhir</h6>
                <span class="badge bg-light text-secondary border">History</span>
             </div>
             <div class="card-body p-0">
               {% if work_logs %}
                 <ul class="list-group list-group-flush small">
                   {% for log in work_logs %}
                   <li class="list-group-item px-4 py-3">
                     <div class="d-flex">
                       <div class="me-3 text-center" style="width:50px;">
                          <span class="d-block fw-bold text-dark">{{ log.created_at.strftime('%d') }}</span>
                          <span class="d-block text-muted" style="font-size:0.7rem;">{{ log.created_at.strftime('%b') }}</span>
                       </div>
                       <div class="border-start ps-3">
                          <div class="fw-bold text-dark mb-1">{{ log.created_at.strftime('%H:%M') }} WIB</div>
                          <div class="text-secondary">{{ log.description }}</div>
                          {% if log.image %}
                            <div class="mt-2">
                              <a href="{{ url_for('static', filename=log.image) }}" target="_blank">
                                <img src="{{ url_for('static', filename=log.image) }}" class="img-thumbnail" style="height:60px;">
                              </a>
                            </div>
                          {% endif %}
                       </div>
                     </div>
                   </li>
                   {% endfor %}
                 </ul>
               {% else %}
                 <div class="p-4 text-center text-muted">
                   <i class="bi bi-inbox fs-4 d-block mb-2"></i>
                   Belum ada catatan aktivitas.
                 </div>
               {% endif %}
             </div>
          </div>
        </div>
      </div>

    </div> <!-- End Col Right -->
  </div> <!-- End Row -->

</div>

<!-- [BARU] MODAL KONFIRMASI RESET PASSWORD -->
<div class="modal fade" id="resetModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-warning-subtle">
        <h5 class="modal-title fw-bold text-dark"><i class="bi bi-exclamation-triangle-fill me-2 text-warning"></i>Reset Password?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center py-4">
        <div class="mb-3">
            <span class="bg-warning-subtle p-3 rounded-circle">
                <i class="bi bi-key-fill fs-1 text-warning"></i>
            </span>
        </div>
        <p class="mb-1">Apakah Anda yakin ingin mereset password untuk:</p>
        <h5 class="fw-bold text-dark">{{ employee.name }}</h5>
        <p class="small text-muted mb-0 px-4">Password lama akan dihapus dan sistem akan membuatkan password acak baru yang akan ditampilkan di layar.</p>
      </div>
      <div class="modal-footer bg-light border-0 justify-content-center">
        <button type="button" class="btn btn-outline-secondary btn-sm px-4" data-bs-dismiss="modal">Batal</button>
        
        <!-- Form Post ke Route Reset -->
        <form action="{{ url_for('hr.reset_password', id=employee.id) }}" method="POST">
            <button type="submit" class="btn btn-warning btn-sm fw-bold px-4 text-dark">
                Ya, Reset Password
            </button>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
  /* Styling tambahan khusus halaman ini */
  .font-corp { font-family: 'Plus Jakarta Sans', sans-serif; }
  
  .card-corp {
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    background: #fff;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }
  .border-top-primary { border-top: 4px solid #1e3a8a; }
  
  .text-uppercase { letter-spacing: 0.5px; }
  
  .hover-shadow:hover {
    background-color: #fff !important;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border-color: #cbd5e1 !important;
  }
</style>
{% endblock %}