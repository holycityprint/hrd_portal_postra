{% extends 'base.html' %}

{% block content %}
<div class="container-fluid p-0 font-corp">

  <!-- HEADER & TOOLBAR -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
    <div>
      <h4 class="fw-bold text-dark mb-1">Direktori Karyawan</h4>
      <p class="text-muted small mb-0">Kelola data personil, penempatan, dan status aktif.</p>
    </div>
    
    <div class="d-flex gap-2 mt-3 mt-md-0">
      <!-- Search Box dengan Style Input Group -->
      <div class="input-group">
        <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
        <input type="search" id="searchBox" class="form-control border-start-0 ps-0" placeholder="Cari nama / posisi...">
      </div>
      
      <!-- Tombol Toggle Form -->
      <button class="btn btn-primary text-nowrap" type="button" data-bs-toggle="collapse" data-bs-target="#formAddEmployee">
        <i class="bi bi-plus-lg me-1"></i> Baru
      </button>
    </div>
  </div>

  <!-- ✏️ FORM TAMBAH KARYAWAN (Collapsible) -->
  <div class="collapse mb-4" id="formAddEmployee">
    <div class="card card-corp border-top-primary">
      <div class="card-header-corp bg-light border-bottom p-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 fw-bold text-dark"><i class="bi bi-person-plus-fill me-2 text-primary"></i>Registrasi Karyawan Baru</h6>
        <button type="button" class="btn-close btn-sm" data-bs-toggle="collapse" data-bs-target="#formAddEmployee"></button>
      </div>
      <div class="card-body p-4">
        <form method="POST" enctype="multipart/form-data" class="row g-3">
          <div class="col-md-3">
            <label class="form-label small text-muted fw-bold">Nama Lengkap</label>
            <input type="text" name="name" class="form-control" placeholder="Sesuai KTP" required>
          </div>
          <div class="col-md-2">
            <label class="form-label small text-muted fw-bold">Posisi / Jabatan</label>
            <input type="text" name="position" class="form-control" placeholder="Contoh: Staff">
          </div>
          <div class="col-md-2">
            <label class="form-label small text-muted fw-bold">Divisi (Job Type)</label>
            <select name="job_type" class="form-select" required>
              <option value="">-- Pilih --</option>
              <option value="security">Security</option>
              <option value="cleaning">Cleaning</option>
              <option value="driver">Driver</option>
              <option value="helper">Helper</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label small text-muted fw-bold">Penempatan Client</label>
            <select name="client_id" class="form-select" required>
              <option value="">-- Pilih Perusahaan --</option>
              {% for c in clients %}
                <option value="{{ c.id }}">{{ c.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label small text-muted fw-bold">Foto Profil</label>
            <input type="file" name="photo" class="form-control" accept="image/*">
          </div>

          <div class="col-12 text-end mt-4 pt-3 border-top">
            <button type="button" class="btn btn-light me-2" data-bs-toggle="collapse" data-bs-target="#formAddEmployee">Batal</button>
            <button class="btn btn-primary px-4" type="submit">Simpan Data</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- SIDEBAR KIRI: FILTER -->
    <div class="col-md-3 col-xl-2 mb-3">
      <div class="card card-corp border-0 shadow-none bg-transparent">
        <div class="list-group list-group-flush rounded-3 bg-white shadow-sm">
          <div class="list-group-item bg-light fw-bold text-dark py-3">
            <i class="bi bi-funnel me-2 text-secondary"></i>Filter Divisi
          </div>
          <a href="#" class="list-group-item list-group-item-action active border-start-primary d-flex justify-content-between align-items-center">
            <span>Semua Divisi</span>
            <i class="bi bi-chevron-right small"></i>
          </a>
          <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <span>Security</span>
          </a>
          <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <span>Cleaning</span>
          </a>
          <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <span>Driver</span>
          </a>
          <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <span>Helper</span>
          </a>
        </div>
        
        <!-- Info box kecil (Optional) -->
        <div class="mt-3 p-3 bg-info-subtle text-info-emphasis rounded-3 small border border-info-subtle">
          <i class="bi bi-info-circle-fill me-1"></i>
          <strong>Tip:</strong> Klik kartu karyawan untuk melihat detail lengkap dan riwayat aktivitas.
        </div>
      </div>
    </div>

    <!-- KOLOM KANAN: GRID KARYAWAN -->
    <div class="col-md-9 col-xl-10">
      <div class="row g-3" id="employeeList">
        {% for e in employees %}
        <div class="col-sm-6 col-lg-4 col-xl-3 employee-card-wrapper">
          <div class="card card-corp h-100 border-top-{{ 'success' if e.status == 'aktif' else 'secondary' }}">
            
            <!-- Status Badge (Absolute) -->
            <div class="position-absolute top-0 end-0 mt-2 me-2">
               <span class="badge rounded-pill {{ 'bg-success-subtle text-success border border-success-subtle' if e.status == 'aktif' else 'bg-secondary-subtle text-secondary border border-secondary-subtle' }}" style="font-size: 0.65rem; text-transform: uppercase;">
                  {{ e.status }}
               </span>
            </div>

            <div class="card-body text-center p-4 cursor-pointer" 
                 onclick="window.location.href='{{ url_for('hr.employee_details', id=e.id) }}'">
              
              <!-- Foto -->
              <div class="mb-3 position-relative d-inline-block">
                <img src="{{ url_for('static', filename='uploads/' ~ e.photo) }}"
                     onerror="this.onerror=null;this.src='{{ url_for('static', filename='img/default_user.png') }}';"
                     alt="Foto" class="rounded-circle shadow-sm"
                     width="80" height="80"
                     style="object-fit:cover; border: 3px solid #f1f5f9;">
              </div>

              <h6 class="fw-bold text-dark mb-1 text-truncate">{{ e.name }}</h6>
              <div class="text-primary small fw-bold mb-2">{{ e.position or 'Staff' }}</div>

              <div class="bg-light rounded p-2 border mb-2 text-start">
                <div class="d-flex align-items-center text-muted small mb-1">
                   <i class="bi bi-building me-2"></i> 
                   <span class="text-truncate d-block" style="max-width: 140px;">
                     {{ e.client.name if e.client else 'Belum ditugaskan' }}
                   </span>
                </div>
                <div class="d-flex align-items-center text-muted small">
                   <i class="bi bi-briefcase me-2"></i> {{ e.job_type|capitalize }}
                </div>
              </div>
            </div>

            <!-- Footer Actions -->
            <div class="card-footer bg-white border-top p-2">
              <div class="d-flex justify-content-center gap-1">
                <!-- Absen -->
                <a href="{{ url_for('hr.employee_attendance_page', employee_id=e.id) }}"
                   class="btn btn-light btn-sm border text-success" data-bs-toggle="tooltip" title="Input Absensi">
                  <i class="bi bi-clock-history"></i>
                </a>

                <!-- Edit -->
                <a href="{{ url_for('hr.edit_employee', id=e.id) }}"
                   class="btn btn-light btn-sm border text-primary" data-bs-toggle="tooltip" title="Edit Data">
                  <i class="bi bi-pencil-square"></i>
                </a>

                <!-- Hapus -->
                <form method="POST" action="{{ url_for('hr.delete_employee', id=e.id) }}" class="d-inline">
                   <button type="submit" class="btn btn-light btn-sm border text-danger"
                           onclick="return confirm('Konfirmasi penghapusan data {{ e.name }}?')"
                           data-bs-toggle="tooltip" title="Hapus Permanen">
                     <i class="bi bi-trash"></i>
                   </button>
                </form>
              </div>
            </div>

          </div>
        </div>
        {% else %}
        <!-- Empty State -->
        <div class="col-12">
          <div class="text-center py-5 bg-white rounded border border-dashed">
            <i class="bi bi-people text-muted fs-1 mb-3 d-block"></i>
            <h6 class="text-dark fw-bold">Database Karyawan Kosong</h6>
            <p class="text-muted small">Belum ada data karyawan yang terdaftar dalam sistem.</p>
            <button class="btn btn-outline-primary btn-sm mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#formAddEmployee">
              <i class="bi bi-plus-lg"></i> Tambah Sekarang
            </button>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- JS Search Logic (Tidak Berubah) -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const searchBox = document.getElementById('searchBox');
    const cards = document.querySelectorAll('.employee-card-wrapper');

    // Init Tooltips Bootstrap 5
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    searchBox.addEventListener('input', function() {
      const term = this.value.toLowerCase();
      cards.forEach(wrapper => {
        const text = wrapper.innerText.toLowerCase();
        if(text.includes(term)) {
          wrapper.classList.remove('d-none');
        } else {
          wrapper.classList.add('d-none');
        }
      });
    });
  });
</script>

<!-- Style Tambahan -->
<style>
  .font-corp { font-family: 'Plus Jakarta Sans', sans-serif; }
  
  .card-corp {
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    background: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    transition: all 0.2s;
  }
  .card-corp:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.08);
    border-color: #cbd5e1;
  }

  .cursor-pointer { cursor: pointer; }

  /* List Group Custom Active */
  .list-group-item.active {
    background-color: #f1f5f9; /* Abu-abu sangat muda */
    color: #0f172a; /* Navy */
    border-color: #e2e8f0;
    border-left: 4px solid #1e3a8a; /* Garis Navy */
    font-weight: 600;
  }
  .border-start-primary { border-left: 4px solid #1e3a8a !important; }

  /* Border Top Colors */
  .border-top-primary { border-top: 4px solid #1e3a8a; }
  .border-top-success { border-top: 4px solid #10b981; }
  .border-top-secondary { border-top: 4px solid #64748b; }
  
  /* Input group focus fix */
  .input-group:focus-within {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
    border-radius: 0.375rem;
  }
  .input-group:focus-within .input-group-text,
  .input-group:focus-within .form-control {
    border-color: #86b7fe;
  }
</style>

{% endblock %}