{% extends 'base.html' %}

{% block content %}
<!-- CSS KHUSUS TAMPILAN MOBILE WORKSPACE -->
<style>
  /* Header dengan lengkungan modern */
  .emp-header {
    background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%); /* Navy Gradient */
    color: #fff;
    border-radius: 0 0 30px 30px;
    padding: 2rem 1.5rem 5rem 1.5rem;
    text-align: center;
    position: relative;
    box-shadow: 0 4px 15px rgba(15, 23, 42, 0.3);
  }
  
  /* Foto Profil dengan Border Glow */
  .profile-img-wrapper {
    position: relative;
    display: inline-block;
    margin-top: 10px;
  }
  .profile-img {
    width: 85px; height: 85px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid rgba(255, 255, 255, 0.3);
    background: #fff;
    padding: 2px;
  }
  .status-dot {
    position: absolute; bottom: 5px; right: 5px;
    width: 15px; height: 15px;
    background: #10b981; /* Online Green */
    border: 2px solid #fff;
    border-radius: 50%;
  }

  /* Kartu Utama (Absensi) yang Melayang */
  .emp-card { 
    margin-top: -60px; 
    border-radius: 20px; 
    border: none;
    background: #fff;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    z-index: 10;
    position: relative;
  }

  /* Form Input Aktivitas */
  .activity-card {
    border-radius: 16px;
    border: 1px solid #e2e8f0;
    background: #f8fafc;
  }
  
  /* Timeline Style untuk Riwayat */
  .timeline-mobile {
    border-left: 2px solid #e2e8f0;
    margin-left: 10px;
    padding-left: 20px;
  }
  .timeline-item {
    position: relative;
    margin-bottom: 20px;
  }
  .timeline-dot {
    position: absolute;
    left: -26px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #3b82f6;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px #e2e8f0;
  }
  .activity-img-preview {
    width: 100%;
    height: 140px;
    object-fit: cover;
    border-radius: 12px;
    margin-top: 10px;
    border: 1px solid #eee;
  }
</style>

<div class="emp-header">
  <!-- Identitas Perusahaan -->
  <div class="d-flex justify-content-center align-items-center mb-2 opacity-75">
    <i class="bi bi-building me-2"></i>
    <small class="text-uppercase fw-bold">{{ employee.client.name if employee.client else "PMM Portal Enterprise" }}</small>
  </div>

  <!-- Nama & Jabatan -->
  <h4 class="fw-bold mb-0">{{ employee.name }}</h4>
  <div class="small text-light opacity-75">{{ employee.position or 'Staff Operasional' }}</div>

  <!-- Foto Profil -->
  <div class="profile-img-wrapper">
    <img src="{{ url_for('static', filename='uploads/' ~ (employee.photo or 'default_user.png')) }}"
         class="profile-img" alt="Profile">
    <div class="status-dot"></div>
  </div>

  <!-- Tombol Update Data Diri -->
  <div class="mt-3">
    <a href="{{ url_for('employee_input_bp.employee_self_input') }}"
       class="btn btn-outline-light btn-sm rounded-pill px-3">
      <i class="bi bi-person-vcard me-1"></i> Update Data Diri
    </a>
  </div>
</div>

<div class="container px-3 pb-5">

  <!-- ===================================================== -->
  <!-- 1. KARTU ABSENSI (UTAMA) -->
  <!-- ===================================================== -->
  <div class="card emp-card mb-4">
    <div class="card-body text-center p-4">
      
      <!-- Info Tanggal -->
      <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
        <div class="text-start">
            <div class="small text-muted text-uppercase fw-bold">Hari Ini</div>
            <div class="fw-bold text-dark">{{ today.strftime('%d %B %Y') }}</div>
        </div>
        <div class="text-end">
            <div class="small text-muted text-uppercase fw-bold">Jadwal</div>
            <div class="fw-bold text-primary">09:00 - 18:00</div>
        </div>
      </div>

      <!-- Status Kehadiran -->
      <div class="py-2 mb-3">
        {% if attendance_today.check_in %}
           <div class="row">
             <div class="col-6 border-end">
               <small class="text-muted">Masuk</small>
               <h4 class="fw-bold text-success mb-0">{{ attendance_today.check_in.strftime('%H:%M') }}</h4>
             </div>
             <div class="col-6">
               <small class="text-muted">Pulang</small>
               <h4 class="fw-bold {{ 'text-danger' if attendance_today.check_out else 'text-secondary' }} mb-0">
                 {{ attendance_today.check_out.strftime('%H:%M') if attendance_today.check_out else '--:--' }}
               </h4>
             </div>
           </div>
        {% else %}
           <h1 class="display-4 fw-bold text-secondary mb-0">--:--</h1>
           <small class="text-muted">Anda belum melakukan absen masuk</small>
        {% endif %}
      </div>

      <!-- Tombol Aksi Besar -->
      <form method="post" action="{{ url_for('employee.do_attendance') }}">
        {% if not attendance_today or not attendance_today.check_in %}
          <button type="submit" name="action" value="clock_in"
                  class="btn btn-primary w-100 py-3 rounded-4 fw-bold fs-5 shadow-sm btn-ripple">
            <i class="bi bi-fingerprint me-2"></i> CLOCK IN (MASUK)
          </button>
        {% elif not attendance_today.check_out %}
          <button type="submit" name="action" value="clock_out"
                  class="btn btn-danger w-100 py-3 rounded-4 fw-bold fs-5 shadow-sm btn-ripple">
            <i class="bi bi-box-arrow-right me-2"></i> CLOCK OUT (PULANG)
          </button>
        {% else %}
          <div class="alert alert-success border-0 bg-success-subtle text-success fw-bold d-flex align-items-center justify-content-center">
            <i class="bi bi-check-circle-fill me-2 fs-4"></i> Tugas Hari Ini Selesai
          </div>
        {% endif %}
      </form>

    </div>
  </div>

  <!-- ===================================================== -->
  <!-- 2. FORM LAPORAN AKTIVITAS -->
  <!-- ===================================================== -->
  <h6 class="fw-bold text-dark px-2 mb-2"><i class="bi bi-camera-fill me-2 text-warning"></i>Lapor Aktivitas</h6>
  
  <div class="card activity-card shadow-sm mb-4">
    <div class="card-body p-3">
      <form action="{{ url_for('employee.upload_activity') }}"
            method="post" enctype="multipart/form-data" id="activityForm">

        <div class="mb-3">
          <textarea name="description" class="form-control border-0 bg-white shadow-sm"
                    rows="3" placeholder="Sedang mengerjakan apa sekarang?..." required style="resize: none;"></textarea>
        </div>

        <div class="row g-2 align-items-center">
           <div class="col-8">
              <label class="btn btn-light border w-100 text-start text-muted text-truncate">
                  <i class="bi bi-camera me-2"></i> <span id="fileName">Ambil Foto...</span>
                  <input type="file" name="photo" id="photoInput" class="d-none" accept="image/*" capture="camera" required onchange="updateFileName()">
              </label>
           </div>
           <div class="col-4">
              <button class="btn btn-primary w-100" type="submit">
                 <i class="bi bi-send-fill"></i> Kirim
              </button>
           </div>
        </div>

        <!-- Hidden GPS -->
        <input type="hidden" name="latitude" id="latitude">
        <input type="hidden" name="longitude" id="longitude">
        
        <!-- Indikator GPS -->
        <div id="loc-status" class="mt-2 small text-muted d-flex align-items-center">
           <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
           Mencari titik lokasi GPS...
        </div>

      </form>
    </div>
  </div>

  <!-- ===================================================== -->
  <!-- 3. TIMELINE RIWAYAT HARI INI -->
  <!-- ===================================================== -->
  <h6 class="fw-bold text-dark px-2 mb-3"><i class="bi bi-clock-history me-2 text-primary"></i>Timeline Hari Ini</h6>

  <div class="timeline-mobile">
    {% if employee.activity_log %}
      {% for a in employee.activity_log|sort(attribute='created_at', reverse=True) %}
        <div class="timeline-item">
          <div class="timeline-dot"></div>
          <div class="card border-0 shadow-sm">
             <div class="card-body p-3">
                <div class="d-flex justify-content-between mb-1">
                   <span class="badge bg-primary-subtle text-primary fw-bold">{{ a.created_at.strftime('%H:%M') }}</span>
                   {% if a.latitude and a.longitude %}
                    <a href="https://www.google.com/maps?q={{ a.latitude }},{{ a.longitude }}" target="_blank" class="text-decoration-none small text-muted">
                      <i class="bi bi-geo-alt-fill text-danger"></i> Lokasi
                    </a>
                   {% endif %}
                </div>
                
                <p class="mb-0 text-dark small fw-medium">{{ a.description }}</p>
                
                {% if a.image %}
                  <img src="{{ url_for('static', filename=a.image) }}" class="activity-img-preview shadow-sm">
                {% endif %}
             </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="text-center py-4 text-muted">
         <i class="bi bi-journal-x fs-1 d-block mb-2 opacity-50"></i>
         Belum ada aktivitas tercatat hari ini.
      </div>
    {% endif %}
  </div>

</div>

<!-- SCRIPT GPS & UX -->
<script>
// 1. Update nama file saat foto dipilih
function updateFileName() {
    const input = document.getElementById('photoInput');
    const label = document.getElementById('fileName');
    if (input.files && input.files.length > 0) {
        label.textContent = input.files[0].name;
        label.classList.add('text-primary', 'fw-bold');
    }
}

// 2. Ambil Lokasi Otomatis
document.addEventListener("DOMContentLoaded", function() {
  const status = document.getElementById("loc-status");
  
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        document.getElementById("latitude").value = pos.coords.latitude;
        document.getElementById("longitude").value = pos.coords.longitude;
        // Update UI Sukses
        status.innerHTML = `<i class="bi bi-check-circle-fill text-success me-2"></i> Lokasi Terkunci Akurat`;
        status.classList.remove("text-muted");
        status.classList.add("text-success", "fw-bold");
      },
      (err) => {
        // Update UI Gagal
        status.innerHTML = `<i class="bi bi-exclamation-triangle-fill text-danger me-2"></i> Gagal: ${err.message}`;
        status.classList.add("text-danger");
      },
      { enableHighAccuracy: true } // Paksa GPS presisi tinggi
    );
  } else {
    status.textContent = "‚ùå Perangkat tidak mendukung GPS.";
  }
});
</script>

{% endblock %}